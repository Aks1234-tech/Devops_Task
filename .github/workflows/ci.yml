name: CI

on:
  push:
    branches: [ main]
  pull_request:
    branches: [ main]

jobs:
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci
      - name: Build frontend
        working-directory: frontend
        run: npm run build --if-present
      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/build

  backend:
    name: Backend CI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install backend requirements
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Quick import check
        working-directory: backend
        run: |
          python -c "import importlib; importlib.import_module('app.main'); print('import ok')"

      - name: Start uvicorn (background)
        working-directory: backend
        run: |
          nohup python -m uvicorn app.main:app --host 127.0.0.1 --port 8000 --log-level warning > uvicorn.log 2>&1 &
          echo $! > uvicorn.pid

      - name: Wait for HTTP endpoint
        working-directory: backend
        run: |
          for i in {1..30}; do
            if curl -sSf http://127.0.0.1:8000/ >/dev/null; then
              echo "server is up"
              exit 0
            fi
            sleep 1
          done
          echo "backend did not start" && cat uvicorn.log && exit 1

      - name: Run backend tests (if any)
        working-directory: backend
        run: |
          if [ -f pytest.ini ] || [ -d tests ]; then
            pip install pytest
            pytest -q
          else
            echo "No tests found; skipping pytest"
          fi

      - name: Shutdown uvicorn
        working-directory: backend
        if: always()
        run: |
          if [ -f uvicorn.pid ]; then
            kill "$(cat uvicorn.pid)" || true
          fi
          sleep 1
